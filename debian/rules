#!/usr/bin/make -f
# debian/rules for onefinity-firmware

# Disable hardening flags that AVR toolchain doesn't support or that fail with legacy code
# AVR toolchain (avr-g++) is older and doesn't support some modern GCC features
# format-security disabled due to legacy printf usage in AVR code
export DEB_BUILD_MAINT_OPTIONS = hardening=-stackprotector,-format reproducible=-fixfilepath

%:
	dh $@

override_dh_auto_clean:
	# Clean build artifacts
	rm -rf build dist node_modules src/svelte-components/node_modules
	rm -rf src/svelte-components/dist
	find . -type f -name '*.pyc' -delete
	find . -type d -name '__pycache__' -delete
	dh_auto_clean

override_dh_auto_build:
	# Build frontend components using main Makefile
	# This creates build/http/ directory with compiled frontend
	npm install
	cd src/svelte-components && npm install
	$(MAKE) all
	
	# Build gplan module (only on ARM, skip on other architectures)
	# This requires scons, build-essential, libssl-dev, python3-dev
	if [ -x scripts/gplan-build-native.sh ]; then \
		./scripts/gplan-build-native.sh || echo "Warning: gplan build failed, continuing without it"; \
	fi
	
	# Build Python package wheel
	python3 setup.py bdist_wheel

override_dh_auto_install:
	# Install Python package using pip (avoids pkg_resources entry point issues)
	# This method generates proper entry points compatible with pip-installed dependencies
	# Use --prefix=/usr to install to /usr/bin instead of /usr/local/bin
	pip3 install --root=$(CURDIR)/debian/onefinity-firmware --prefix=/usr --no-deps --ignore-installed dist/*.whl
	
	# Install HTTP frontend
	mkdir -p $(CURDIR)/debian/onefinity-firmware/opt/onefinity/http
	cp -r build/http/* $(CURDIR)/debian/onefinity-firmware/opt/onefinity/http/
	
	# Install AVR firmware
	mkdir -p $(CURDIR)/debian/onefinity-firmware/opt/onefinity/firmware
	cp src/avr/bbctrl-avr-firmware.hex $(CURDIR)/debian/onefinity-firmware/opt/onefinity/firmware/
	
	# Install system scripts
	mkdir -p $(CURDIR)/debian/onefinity-firmware/opt/onefinity/bin
	install -m 755 scripts/update-bbctrl $(CURDIR)/debian/onefinity-firmware/opt/onefinity/bin/
	install -m 755 scripts/upgrade-bbctrl $(CURDIR)/debian/onefinity-firmware/opt/onefinity/bin/
	install -m 755 scripts/config-wifi $(CURDIR)/debian/onefinity-firmware/opt/onefinity/bin/
	install -m 755 scripts/config-screen $(CURDIR)/debian/onefinity-firmware/opt/onefinity/bin/
	install -m 755 scripts/browser $(CURDIR)/debian/onefinity-firmware/opt/onefinity/bin/
	install -m 755 scripts/avr109-flash.py $(CURDIR)/debian/onefinity-firmware/opt/onefinity/bin/
	
	# Install systemd service
	mkdir -p $(CURDIR)/debian/onefinity-firmware/etc/systemd/system
	install -m 644 scripts/bbctrl.service $(CURDIR)/debian/onefinity-firmware/etc/systemd/system/onefinity.service
	
	# Create directories for runtime
	mkdir -p $(CURDIR)/debian/onefinity-firmware/var/log/onefinity
	mkdir -p $(CURDIR)/debian/onefinity-firmware/var/lib/onefinity

override_dh_auto_test:
	# Skip tests for now
	@echo "Skipping tests"
